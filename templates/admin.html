{% extends 'base.html' %}
{% block title %}Panel admina — Tarcze{% endblock %}

{% block content %}

<h2 class="mb-4 text-center fw-bold">Panel admina</h2>

<div class="row justify-content-center mb-5">
    <div class="col-12 col-lg-10">
        <div class="card shadow border-0 rounded-3">
            <div class="card-header bg-primary text-white py-3">
                <h5 class="mb-0 text-center">Dodaj nową tarczę</h5>
            </div>
            <div class="card-body p-4">
                <form method="POST" enctype="multipart/form-data">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" placeholder="Ulica" name="street" required>
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control" placeholder="Klient / Imię i nazwisko" name="client" required>
                        </div>
                        <div class="col-md-2">
                            <input type="number" step="0.01" min="0" class="form-control" placeholder="Kwota" name="amount" required>
                        </div>
                        <div class="col-md-2">
                            <input type="file" class="form-control" name="photo" accept="image/jpeg,image/png">
                        </div>
                    </div>
                    <div class="mt-3 text-end">
                        <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary me-2">Wyloguj</a>
                        <button type="submit" class="btn btn-primary">Dodaj</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<h3 class="mb-4 text-center">Lista tarcz (łącznie: {{ pagination.total }})</h3>

<div class="card shadow border-0 rounded-3">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Ulica</th>
                        <th>Klient</th>
                        <th>Kwota</th>
                        <th>Data utworzenia</th>
                        <th>Status</th>
                        <th>Data płatności</th>
                        <th class="text-center">Zdjęcie</th>
                        <th class="text-center">QR</th>
                        <th class="text-center">Akcje</th>
                    </tr>
                </thead>
                <tbody>
                    {% for shield in shields %}
                    <tr>
                        <td class="fw-bold text-center">{{ shield.id }}</td>
                        <td>{{ shield.street }}</td>
                        <td>{{ shield.client }}</td>
                        <td class="fw-bold text-end">{{ shield.amount | format_money }} zł</td>
                        <td class="text-center">{{ shield.date_created.strftime('%d.%m.%Y %H:%M') }}</td>
                        <td class="text-center">
                            {% if shield.paid %}
                                <span class="badge bg-success">Opłacono</span>
                            {% else %}
                                <span class="badge bg-danger">Nieopłacono</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if shield.paid_date %}
                                {{ shield.paid_date.strftime('%d.%m.%Y %H:%M') }}
                            {% else %}
                                —
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if shield.photo_path %}
                                <a href="{{ shield.photo_path }}" target="_blank">
                                    <i class="bi bi-image fs-4 text-primary"></i>
                                </a>
                            {% else %}
                                —
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <a href="{{ url_for('download_qr', shield_id=shield.id) }}" class="btn btn-sm btn-outline-primary me-1">
                                <i class="bi bi-qr-code"></i>
                            </a>
                            <a href="{{ url_for('toggle_paid', shield_id=shield.id) }}" 
                               class="btn btn-sm {{ 'btn-success' if shield.paid else 'btn-warning' }} text-white me-1">
                                {{ 'Nieopłacono' if shield.paid else 'Opłacono' }}
                            </a>
                            <form action="{{ url_for('delete_shield', shield_id=shield.id) }}" method="POST" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-danger" 
                                        onclick="return confirm('Czy na pewno usunąć tarczę nr {{ shield.id }}? Tej operacji nie da się cofnąć.');">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="10" class="text-center py-4 text-muted">Nie ma jeszcze tarcz</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% if pagination.pages > 1 %}
    <div class="card-footer bg-white border-0">
        <nav>
            <ul class="pagination justify-content-center mb-0">
                {% if pagination.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ pagination.prev_num }}&sort={{ sort_by }}&dir={{ sort_dir }}">&laquo;</a>
                </li>
                {% endif %}

                {% for p in pagination.iter_pages(left_edge=2, right_edge=2) %}
                    {% if p %}
                        <li class="page-item {{ 'active' if p == pagination.page }}">
                            <a class="page-link" href="?page={{ p }}&sort={{ sort_by }}&dir={{ sort_dir }}">{{ p }}</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                {% endfor %}

                {% if pagination.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ pagination.next_num }}&sort={{ sort_by }}&dir={{ sort_dir }}">&raquo;</a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

{% endblock %}